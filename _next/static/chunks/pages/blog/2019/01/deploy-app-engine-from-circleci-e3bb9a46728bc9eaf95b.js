(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[790],{3905:function(e,t,n){"use strict";n.d(t,{kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"===typeof e?e(t):l(l({},t),e)),n},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||i;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"===typeof e||r){var i=n.length,l=new Array(i);l[0]=p;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"===typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},911:function(e,t,n){"use strict";n.d(t,{Z:function(){return f}});n(7294);var a=n(9008),r=n(1664),i=n(1163),l=n(4184),o=n.n(l),s=n(381),c=n.n(s),u=n(7814),p=n(4007),m=n(5893),d=function(e){return(0,m.jsxs)("aside",{className:o()("widget mb-4",e.className),children:[(0,m.jsx)("h1",{className:"title font-weight-bold",children:e.title}),e.children]})},h=function(e){return e||"https://yuku.takahashi.coffee".concat(p.hs)},f=(0,i.withRouter)((function(e){return(0,m.jsxs)("div",{className:"blogpage container",children:[(0,m.jsxs)(a.default,{children:[(0,m.jsxs)("title",{children:[e.meta.title," - ",p.px]}),(0,m.jsx)("meta",{name:"description",content:e.meta.description}),(0,m.jsx)("meta",{name:"twitter:card",content:"summary"}),(0,m.jsx)("meta",{name:"twitter:creator",content:"@yuku_t"}),(0,m.jsx)("meta",{property:"fb:app_id",content:p.f6}),(0,m.jsx)("meta",{property:"og:title",content:"".concat(e.meta.title," - ").concat(p.px)}),(0,m.jsx)("meta",{property:"og:type",content:"article"}),(0,m.jsx)("meta",{property:"og:url",content:"https://yuku.takahashi.coffee".concat(e.router.pathname)}),(0,m.jsx)("meta",{property:"og:image",content:h()}),(0,m.jsx)("meta",{property:"og:description",content:e.meta.description}),(0,m.jsx)("link",{rel:"stylesheet",href:"https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css"}),(0,m.jsx)("link",{rel:"stylesheet",href:"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css"})]}),(0,m.jsxs)("div",{className:"row",children:[(0,m.jsx)("main",{className:o()("col-xl-8",e.className),children:(0,m.jsxs)("article",{itemScope:!0,itemType:"http://schema.org/BlogPosting",children:[(0,m.jsx)("meta",{itemProp:"author",content:"Yuku Takahashi"}),(0,m.jsx)("meta",{itemProp:"datePublished",content:e.meta.publishedAt}),e.meta.modifiedAt&&(0,m.jsx)("meta",{itemProp:"dateModified",content:e.meta.modifiedAt}),(0,m.jsx)("meta",{itemProp:"image",content:h()}),(0,m.jsxs)("header",{className:"mb-4 header",children:[(0,m.jsx)("h1",{className:"headline",itemProp:"headline",children:e.meta.title}),(0,m.jsxs)("ul",{className:"list-inline text-dark font-weight-light",children:[(0,m.jsx)("li",{className:"list-inline-item",children:(0,m.jsx)("span",{className:"ml-1",children:c()(e.meta.publishedAt).format("YYYY-MM-DD HH:mm")})}),(0,m.jsx)("li",{className:"list-inline-item",children:e.meta.tags.map((function(e,t){return[t>0?",":null,(0,m.jsxs)("span",{className:"ml-1",children:["#",e]},t)]}))})]})]}),(0,m.jsx)("section",{className:"mb-4 body",itemProp:"articleBody",children:e.children})]})}),(0,m.jsx)("div",{className:"col-xl-4",children:(0,m.jsxs)("div",{className:"pl-xl-2",children:[(0,m.jsx)(d,{title:"About Me",children:(0,m.jsxs)("div",{children:[(0,m.jsx)("img",{src:p.hs,alt:"avatar",className:"avatar rounded-circle mb-4 mx-auto d-block"}),(0,m.jsxs)("p",{children:["Software Engineer at FLYWHEEL. Working mainly on recommendation systems in these days. Ex-Qiita CTO.",(0,m.jsx)(r.default,{href:"/about",children:(0,m.jsx)("a",{href:"/about",style:{marginLeft:"4px"},children:"Read more"})}),"."]})]})}),(0,m.jsx)(d,{title:"Follow",children:(0,m.jsxs)("ul",{className:"list-inline icons",children:[(0,m.jsx)("li",{className:"list-inline-item",children:(0,m.jsx)("a",{href:"https://twitter.com/yuku_t",children:(0,m.jsxs)("span",{className:"fa-stack fa-lg",children:[(0,m.jsx)(u.G,{icon:"circle",className:"fa-stack-2x"}),(0,m.jsx)(u.G,{icon:["fab","twitter"],inverse:!0,className:"fa-stack-1x"})]})})}),(0,m.jsx)("li",{className:"list-inline-item",children:(0,m.jsx)("a",{href:"https://github.com/yuku",children:(0,m.jsxs)("span",{className:"fa-stack fa-lg",children:[(0,m.jsx)(u.G,{icon:"circle",className:"fa-stack-2x"}),(0,m.jsx)(u.G,{icon:["fab","github"],inverse:!0,className:"fa-stack-1x"})]})})}),(0,m.jsx)("li",{className:"list-inline-item",children:(0,m.jsx)("a",{href:"/static/rss-feed.xml",children:(0,m.jsxs)("span",{className:"fa-stack fa-lg",children:[(0,m.jsx)(u.G,{icon:"circle",className:"fa-stack-2x"}),(0,m.jsx)(u.G,{icon:"rss",inverse:!0,className:"fa-stack-1x"})]})})})]})})]})})]})]})}))},2922:function(e,t,n){"use strict";var a=n(7294),r=n(911),i=n(5893);t.Z=function(e){var t=e.meta,n=e.children;return(0,a.useEffect)((function(){if(t.loadTwitterWidget){var e=document.createElement("script");e.async=!0,e.src="https://platform.twitter.com/widgets.js",document.body.appendChild(e)}}),[t.loadTwitterWidget]),(0,i.jsx)(r.Z,{className:"mdx",meta:t,children:n})}},8323:function(e,t,n){"use strict";n.r(t),n.d(t,{metadata:function(){return s},default:function(){return p}});var a=n(159),r=n(219),i=(n(7294),n(3905)),l=n(2922),o=["components"],s={description:"How to deploy ann app running on AppEngine Node.js standard environment using CircleCI",modifiedAt:"2019-01-20T09:33:00+09:00",publishedAt:"2019-01-18T14:00:00+09:00",tags:["GCP"],title:"Deploy AppEngine Apps Using CircleCI"},c={metadata:s},u=function(e){var t=e.children;return(0,i.kt)(l.Z,{meta:s},t)};function p(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"I have implemented continuous delivery of Google AppEngine applications using CircleCI:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Deploy to staging on pushing to ",(0,i.kt)("inlineCode",{parentName:"li"},"master")," branch."),(0,i.kt)("li",{parentName:"ul"},"Deploy to production on pushing a tag matching ",(0,i.kt)("inlineCode",{parentName:"li"},"/^v\\d+\\.\\d+\\.\\d+$/"),".")),(0,i.kt)("p",null,"This configuration is quite useful and I'm sure I'll have a chance to reuse it. In this article I describe the implementation details."),(0,i.kt)("h2",null,"Create a Service Account"),(0,i.kt)("p",null,"At first, I created a service account that will be used to authenticate Cloud SDK in CircleCI:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a new account at ",(0,i.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/iam-admin/serviceaccounts"},"Service Accounts")," of Google Cloud Platform Console:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},'Named "circleci" to make it easy to guess what is\'s for.'),(0,i.kt)("li",{parentName:"ul"},"Created a key and download it in JSON."))),(0,i.kt)("li",{parentName:"ol"},"Attach roles to the created service account at ",(0,i.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/iam-admin/iam"},"IAM")," page:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"App Engine Deployer (",(0,i.kt)("inlineCode",{parentName:"li"},"appengine.deployer"),")"),(0,i.kt)("li",{parentName:"ul"},"App Engine Service Admin (",(0,i.kt)("inlineCode",{parentName:"li"},"appengine.serviceAdmin"),")"),(0,i.kt)("li",{parentName:"ul"},"Cloud Build Editor (",(0,i.kt)("inlineCode",{parentName:"li"},"cloudbuild.builds.editor"),")"),(0,i.kt)("li",{parentName:"ul"},"Storage Object Creator (",(0,i.kt)("inlineCode",{parentName:"li"},"storage.objectCreator"),")"),(0,i.kt)("li",{parentName:"ul"},"Storage Object Viewer (",(0,i.kt)("inlineCode",{parentName:"li"},"storage.objectViewer"),")")))),(0,i.kt)("p",null,"Note that it may take a few minutes for the results to be reflected."),(0,i.kt)("p",null,"When you create a new GCP project, a ",(0,i.kt)("inlineCode",{parentName:"p"},"xxx@cloudbuild.gserviceaccount.com")," service account which has a Cloud Build Service Account role is created. You also need to attach the following role to the service account:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Storage Object Viewer")),(0,i.kt)("h2",null,"Configure CircleCI"),(0,i.kt)("p",null,"My GAE application uses ",(0,i.kt)("inlineCode",{parentName:"p"},"nodejs10")," runtime. I added following npm run scripts:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run test"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Run tests"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"npm run build"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Build project and put artifacts to the ",(0,i.kt)("inlineCode",{parentName:"li"},"/build")," directory.")))),(0,i.kt)("p",null,"And I implemented CD using those scripts."),(0,i.kt)("h3",null,"Cloud SDK"),(0,i.kt)("p",null,"I use ",(0,i.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/google/cloud-sdk/"},"google/cloud-sdk")," image which was described in ",(0,i.kt)("a",{parentName:"p",href:"/blog/2019/01/google-cloud-sdk-in-docker"},"How to Use Google Cloud SDK Using Docker"),":"),(0,i.kt)("p",null,"Set the downloaded JSON key as ",(0,i.kt)("inlineCode",{parentName:"p"},"GCLOUD_SERVICE_KEY")," environment variable, then do following command to authenticate Cloud SDK:"),(0,i.kt)("pre",{className:"language-bash"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},(0,i.kt)("span",{parentName:"code",className:"token builtin class-name"},"echo")," ",(0,i.kt)("span",{parentName:"code",className:"token variable"},"$GCLOUD_SERVICE_KEY")," ",(0,i.kt)("span",{parentName:"code",className:"token operator"},"|")," gcloud auth activate-service-account --key-file",(0,i.kt)("span",{parentName:"code",className:"token operator"},"="),"-\n")),(0,i.kt)("h3",null,"workspace"),(0,i.kt)("p",null,"Build artifacts (generated by ",(0,i.kt)("inlineCode",{parentName:"p"},"npm run build"),") are required to deploy."),(0,i.kt)("p",null,"Node.js is required to run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm")," command but the google/cloud-sdk image does not contain Node.js runtime. There are some way to solve this problem:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a Docker image with both Node.js and Cloud SDK and use it."),(0,i.kt)("li",{parentName:"ol"},"Store build artifacts somewhere and use it in the Cloud SDK container.")),(0,i.kt)("p",null,"I started by 1. but finally found that ",(0,i.kt)("a",{parentName:"p",href:"https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs"},"I can use workspaces to share files across jobs")," so adopted 2."),(0,i.kt)("h3",null,"Deploy"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"gcloud app deploy")," command deploys your application to GAE. I used the following options:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--version"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Give the version name."),(0,i.kt)("li",{parentName:"ul"},"You can replace an existing version by specifing the same version name."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"--no-promote"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Don't route traffic to the newly created version after deployment.")))),(0,i.kt)("h2",null,"Conclusion"),(0,i.kt)("p",null,"You may think it's hard to set up continuous delivery in the early stages of a project. However, from a medium- to long-term perspective, I think these efforts are worthwhile."),(0,i.kt)("h2",null,"References"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://circleci.com/docs/2.0/google-auth/"},"Authorizing the Google Cloud SDK - CircleCI")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://cloud.google.com/sdk/docs/authorizing#authorizing_with_a_service_account"},"Authorizing Cloud SDK tools \xa0|\xa0 Cloud SDK Documentation \xa0|\xa0 Google Cloud")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs"},"Using Workflows to Schedule Jobs - CircleCI")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://cloud.google.com/sdk/gcloud/reference/app/deploy"},"gcloud app deploy \xa0|\xa0 Cloud SDK \xa0|\xa0 Google Cloud"))))}p.isMDXComponent=!0},8099:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2019/01/deploy-app-engine-from-circleci",function(){return n(8323)}])},159:function(e,t,n){"use strict";function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}n.d(t,{Z:function(){return a}})},219:function(e,t,n){"use strict";function a(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}n.d(t,{Z:function(){return a}})}},function(e){e.O(0,[885,774,888,179],(function(){return t=8099,e(e.s=t);var t}));var t=e.O();_N_E=t}]);