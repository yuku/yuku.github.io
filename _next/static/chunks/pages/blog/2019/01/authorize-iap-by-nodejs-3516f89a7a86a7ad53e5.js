(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[881],{7140:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return h}});var n=t(809),o=t.n(n),s=t(5311),c=t(5893),p=(t(7294),t(7871)),r=t(6265),m=t(8347),l=t(3905);function k(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function u(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?k(Object(t),!0).forEach((function(a){(0,r.Z)(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):k(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}var N={};function i(e){var a=e.components,t=(0,m.Z)(e,["components"]);return(0,l.kt)("wrapper",u(u(u({},N),t),{},{components:a,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Because ",(0,l.kt)("a",u({parentName:"p"},{href:"https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_service_account"}),"Google's official document")," doesn't explain how to do it in Node.js, it was difficult for me to access Cloud IAP-protected GAE resources from Node.js."),(0,l.kt)("p",null,"In short, I could do that by following ",(0,l.kt)("a",u({parentName:"p"},{href:"https://github.com/googleapis/google-auth-library-nodejs/blob/d3fb55e0a710/samples/iap.js"}),"this example"),". In this blog post, I'll leave a record of what I learned on the way there."),(0,l.kt)("h2",null,"What is Cloud IAP"),(0,l.kt)("p",null,(0,l.kt)("a",u({parentName:"p"},{href:"https://cloud.google.com/iap/"}),"Cloud Identity-Aware Proxy")," (Cloud IAP) is a service of Google Cloud Platform that provides authentication to resources on GCP."),(0,l.kt)("p",null,"Because only authenticated requests reach an app behind Cloud IAP, you don't need to implement authentication to the app by yourself."),(0,l.kt)("p",null,"With Cloud IAP, you can authorize only the users linked to a specific G Suite account. So it's especially useful when creating a company internal system."),(0,l.kt)("h2",null,"Information required for authentication"),(0,l.kt)("p",null,"To let Cloud IAP authenticate your request, three pieces of information are required:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Client ID for OAuth2 authentication in Cloud IAP"),(0,l.kt)("li",{parentName:"ol"},"Service account email address"),(0,l.kt)("li",{parentName:"ol"},"Service account private key")),(0,l.kt)("p",null,"If you give them to GCP, it's pretty intuitive that GCP can check"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"What you're trying to access"),(0,l.kt)("li",{parentName:"ul"},"Who is accessing the site and is it him?"),(0,l.kt)("li",{parentName:"ul"},"Does he have access to it?")),(0,l.kt)("p",null,"You will also obviously need to set up permissions on your service account in advance."),(0,l.kt)("h3",null,"Authenticate with Node.js"),(0,l.kt)("p",null,'First of all, you need to create a service account and add it to the "IAP-secured Web App User". While creating the account, you can obtain its Client ID.'),(0,l.kt)("blockquote",null,(0,l.kt)("ol",u({parentName:"blockquote"},{start:2}),(0,l.kt)("li",{parentName:"ol"},"Service account email address."),(0,l.kt)("li",{parentName:"ol"},"Service account private key"))),(0,l.kt)("p",null,"They are included in the JSON file that you can download when you issue a key on the service account page. Make sure that you don't git commit your private key because you should never spill it to the outside world. This is necessary regardless of the programming language."),(0,l.kt)("p",null,"Then, we can use ",(0,l.kt)("a",u({parentName:"p"},{href:"https://npmjs.com/package/google-auth-library"}),"google-auth-library")," to authenticate with Node.js."),(0,l.kt)("p",null,"The google-auth-library automatically creates a client based on our environment, but in this case, we'll create a ",(0,l.kt)("inlineCode",{parentName:"p"},"JWT")," instance by ourself:"),(0,l.kt)("pre",u({},{className:"language-js"}),(0,l.kt)("code",u({parentName:"pre"},{className:"language-js"}),(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"JWT")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"require"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"google-auth-library"'),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," client ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"new")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token class-name"}),"JWT"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{"),"\n  email",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_EMAIL"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"  ",(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// 2. Service account email address"),"\n  key",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_PRIVATE_KEY"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"  ",(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// 3. Service account private key"),"\n  additionalClaims",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{"),"\n    target_audience",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"OAUTH2CLIENT_ID"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"  ",(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// 1. Client ID for OAuth2 authentication in Cloud IAP"),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n")),(0,l.kt)("p",null,"As you can see, the ",(0,l.kt)("inlineCode",{parentName:"p"},"client")," has the three information described above."),(0,l.kt)("p",null,"To access a resource, we need to get an access token and assemble an ",(0,l.kt)("inlineCode",{parentName:"p"},"Authorization")," header, and there is a handy method called ",(0,l.kt)("inlineCode",{parentName:"p"},"getRequestHeaders()"),"."),(0,l.kt)("pre",u({},{className:"language-js"}),(0,l.kt)("code",u({parentName:"pre"},{className:"language-js"}),(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// URL of resource protected by Cloud IAP"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," url ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"http://example.appspot.com/path/to/endpoint"'),"\n\n",(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// { Authorization: 'Bearer <access_token_value>' }"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," headers ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword control-flow"}),"await")," client",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token method function property-access"}),"getRequestHeaders"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),"url",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n")),(0,l.kt)("p",null,"If you are using ",(0,l.kt)("a",u({parentName:"p"},{href:"https://npmjs.com/package/axios"}),"axios"),", you can use the ",(0,l.kt)("inlineCode",{parentName:"p"},"url")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"headers")," as:"),(0,l.kt)("pre",u({},{className:"language-js"}),(0,l.kt)("code",u({parentName:"pre"},{className:"language-js"}),(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," axios ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"require"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"axios"'),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\naxios",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token method function property-access"}),"request"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{")," url",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),",")," headers ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n")),(0,l.kt)("p",null,"However, this is quite common, so ",(0,l.kt)("inlineCode",{parentName:"p"},"client")," provides a method to send a request which internally uses gaxios that is compatible with axios."),(0,l.kt)("pre",u({},{className:"language-js"}),(0,l.kt)("code",u({parentName:"pre"},{className:"language-js"}),(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// Almost same as the sample code using axios above."),"\nclient",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token method function property-access"}),"request"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{")," url ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n")),(0,l.kt)("p",null,"Consequently, you can access a resource protected by Cloud IAP as follows:"),(0,l.kt)("pre",u({},{className:"language-js"}),(0,l.kt)("code",u({parentName:"pre"},{className:"language-js"}),(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"JWT")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"require"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"google-auth-library"'),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"OAUTH2_CLIENT_ID")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"..."'),"\n\n",(0,l.kt)("span",u({parentName:"code"},{className:"token comment"}),"// Downloaded credentials JSON file."),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," credentials ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"require"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"./service-account-credentials.json"'),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_EMAIL")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," credentials",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token property-access"}),"client_email"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_PRIVATE_KEY")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," credentials",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token property-access"}),"private_key"),"\n\n",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"async")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"function")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"main"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," client ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"new")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token class-name"}),"JWT"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{"),"\n    email",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_EMAIL"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"\n    key",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"SERVICE_ACCOUNT_PRIVATE_KEY"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"\n    additionalClaims",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{"),"\n      target_audience",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),":")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token constant"}),"OAUTH2_CLIENT_ID"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"\n    ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),","),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," url ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token string"}),'"http://example.appspot.com"'),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword"}),"const")," result ",(0,l.kt)("span",u({parentName:"code"},{className:"token operator"}),"=")," ",(0,l.kt)("span",u({parentName:"code"},{className:"token keyword control-flow"}),"await")," client",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token method function property-access"}),"request"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"{")," url ",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n  ",(0,l.kt)("span",u({parentName:"code"},{className:"token console class-name"}),"console"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token method function property-access"}),"log"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),"result",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token property-access"}),"data"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n",(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",(0,l.kt)("span",u({parentName:"code"},{className:"token function"}),"main"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token keyword control-flow"}),"catch"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"("),(0,l.kt)("span",u({parentName:"code"},{className:"token console class-name"}),"console"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"."),(0,l.kt)("span",u({parentName:"code"},{className:"token property-access"}),"error"),(0,l.kt)("span",u({parentName:"code"},{className:"token punctuation"}),")"),"\n")),(0,l.kt)("h2",null,"References"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",u({parentName:"li"},{href:"https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_service_account"}),"Programmatic authentication \xa0|\xa0 Identity-Aware Proxy \xa0|\xa0 Google Cloud")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",u({parentName:"li"},{href:"https://github.com/googleapis/google-auth-library-nodejs/blob/d3fb55e0a710/samples/iap.js"}),"google-auth-library-nodejs/iap.js at d3fb55e \xb7 googleapis/google-auth-library-nodejs"))))}i.isMDXComponent=!0;var d=function(e){var a=e.meta;return(0,c.jsx)(p.i,{meta:a,children:(0,c.jsx)(i,{})})};d.getInitialProps=(0,s.Z)(o().mark((function e(){var a,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t(405),n=a.entries,e.abrupt("return",{meta:n["blog/2019/01/authorize-iap-by-nodejs"]});case 2:case"end":return e.stop()}}),e)})));var h=d},7335:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2019/01/authorize-iap-by-nodejs",function(){return t(7140)}])}},function(e){e.O(0,[885,663,774,888,179],(function(){return a=7335,e(e.s=a);var a}));var a=e.O();_N_E=a}]);