(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[790],{9461:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return g}});var a=n(809),o=n.n(a),l=n(5311),r=n(5893),i=(n(7294),n(7871)),u=n(6265),c=n(8347),p=n(3905);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,u.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var m={};function k(e){var t=e.components,n=(0,c.Z)(e,["components"]);return(0,p.kt)("wrapper",d(d(d({},m),n),{},{components:t,mdxType:"MDXLayout"}),(0,p.kt)("p",null,"I have implemented continuous delivery of Google AppEngine applications using CircleCI:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"Deploy to staging on pushing to ",(0,p.kt)("inlineCode",{parentName:"li"},"master")," branch."),(0,p.kt)("li",{parentName:"ul"},"Deploy to production on pushing a tag matching ",(0,p.kt)("inlineCode",{parentName:"li"},"/^v\\d+\\.\\d+\\.\\d+$/"),".")),(0,p.kt)("p",null,"This configuration is quite useful and I'm sure I'll have a chance to reuse it. In this article I describe the implementation details."),(0,p.kt)("h2",null,"Create a Service Account"),(0,p.kt)("p",null,"At first, I created a service account that will be used to authenticate Cloud SDK in CircleCI:"),(0,p.kt)("ol",null,(0,p.kt)("li",{parentName:"ol"},"Create a new account at ",(0,p.kt)("a",d({parentName:"li"},{href:"https://console.cloud.google.com/iam-admin/serviceaccounts"}),"Service Accounts")," of Google Cloud Platform Console:",(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},'Named "circleci" to make it easy to guess what is\'s for.'),(0,p.kt)("li",{parentName:"ul"},"Created a key and download it in JSON."))),(0,p.kt)("li",{parentName:"ol"},"Attach roles to the created service account at ",(0,p.kt)("a",d({parentName:"li"},{href:"https://console.cloud.google.com/iam-admin/iam"}),"IAM")," page:",(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},"App Engine Deployer (",(0,p.kt)("inlineCode",{parentName:"li"},"appengine.deployer"),")"),(0,p.kt)("li",{parentName:"ul"},"App Engine Service Admin (",(0,p.kt)("inlineCode",{parentName:"li"},"appengine.serviceAdmin"),")"),(0,p.kt)("li",{parentName:"ul"},"Cloud Build Editor (",(0,p.kt)("inlineCode",{parentName:"li"},"cloudbuild.builds.editor"),")"),(0,p.kt)("li",{parentName:"ul"},"Storage Object Creator (",(0,p.kt)("inlineCode",{parentName:"li"},"storage.objectCreator"),")"),(0,p.kt)("li",{parentName:"ul"},"Storage Object Viewer (",(0,p.kt)("inlineCode",{parentName:"li"},"storage.objectViewer"),")")))),(0,p.kt)("p",null,"Note that it may take a few minutes for the results to be reflected."),(0,p.kt)("p",null,"When you create a new GCP project, a ",(0,p.kt)("inlineCode",{parentName:"p"},"xxx@cloudbuild.gserviceaccount.com")," service account which has a Cloud Build Service Account role is created. You also need to attach the following role to the service account:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"Storage Object Viewer")),(0,p.kt)("h2",null,"Configure CircleCI"),(0,p.kt)("p",null,"My GAE application uses ",(0,p.kt)("inlineCode",{parentName:"p"},"nodejs10")," runtime. I added following npm run scripts:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("inlineCode",{parentName:"li"},"npm run test"),(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},"Run tests"))),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("inlineCode",{parentName:"li"},"npm run build"),(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},"Build project and put artifacts to the ",(0,p.kt)("inlineCode",{parentName:"li"},"/build")," directory.")))),(0,p.kt)("p",null,"And I implemented CD using those scripts."),(0,p.kt)("h3",null,"Cloud SDK"),(0,p.kt)("p",null,"I use ",(0,p.kt)("a",d({parentName:"p"},{href:"https://hub.docker.com/r/google/cloud-sdk/"}),"google/cloud-sdk")," image which was described in ",(0,p.kt)("a",d({parentName:"p"},{href:"/blog/2019/01/google-cloud-sdk-in-docker"}),"How to Use Google Cloud SDK Using Docker"),":"),(0,p.kt)("p",null,"Set the downloaded JSON key as ",(0,p.kt)("inlineCode",{parentName:"p"},"GCLOUD_SERVICE_KEY")," environment variable, then do following command to authenticate Cloud SDK:"),(0,p.kt)("pre",d({},{className:"language-bash"}),(0,p.kt)("code",d({parentName:"pre"},{className:"language-bash"}),(0,p.kt)("span",d({parentName:"code"},{className:"token builtin class-name"}),"echo")," ",(0,p.kt)("span",d({parentName:"code"},{className:"token variable"}),"$GCLOUD_SERVICE_KEY")," ",(0,p.kt)("span",d({parentName:"code"},{className:"token operator"}),"|")," gcloud auth activate-service-account --key-file",(0,p.kt)("span",d({parentName:"code"},{className:"token operator"}),"="),"-\n")),(0,p.kt)("h3",null,"workspace"),(0,p.kt)("p",null,"Build artifacts (generated by ",(0,p.kt)("inlineCode",{parentName:"p"},"npm run build"),") are required to deploy."),(0,p.kt)("p",null,"Node.js is required to run ",(0,p.kt)("inlineCode",{parentName:"p"},"npm")," command but the google/cloud-sdk image does not contain Node.js runtime. There are some way to solve this problem:"),(0,p.kt)("ol",null,(0,p.kt)("li",{parentName:"ol"},"Create a Docker image with both Node.js and Cloud SDK and use it."),(0,p.kt)("li",{parentName:"ol"},"Store build artifacts somewhere and use it in the Cloud SDK container.")),(0,p.kt)("p",null,"I started by 1. but finally found that ",(0,p.kt)("a",d({parentName:"p"},{href:"https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs"}),"I can use workspaces to share files across jobs")," so adopted 2."),(0,p.kt)("h3",null,"Deploy"),(0,p.kt)("p",null,(0,p.kt)("inlineCode",{parentName:"p"},"gcloud app deploy")," command deploys your application to GAE. I used the following options:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("inlineCode",{parentName:"li"},"--version"),(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},"Give the version name."),(0,p.kt)("li",{parentName:"ul"},"You can replace an existing version by specifing the same version name."))),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("inlineCode",{parentName:"li"},"--no-promote"),(0,p.kt)("ul",{parentName:"li"},(0,p.kt)("li",{parentName:"ul"},"Don't route traffic to the newly created version after deployment.")))),(0,p.kt)("h2",null,"Conclusion"),(0,p.kt)("p",null,"You may think it's hard to set up continuous delivery in the early stages of a project. However, from a medium- to long-term perspective, I think these efforts are worthwhile."),(0,p.kt)("h2",null,"References"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",d({parentName:"li"},{href:"https://circleci.com/docs/2.0/google-auth/"}),"Authorizing the Google Cloud SDK - CircleCI")),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",d({parentName:"li"},{href:"https://cloud.google.com/sdk/docs/authorizing#authorizing_with_a_service_account"}),"Authorizing Cloud SDK tools \xa0|\xa0 Cloud SDK Documentation \xa0|\xa0 Google Cloud")),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",d({parentName:"li"},{href:"https://circleci.com/docs/2.0/workflows/#using-workspaces-to-share-data-among-jobs"}),"Using Workflows to Schedule Jobs - CircleCI")),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",d({parentName:"li"},{href:"https://cloud.google.com/sdk/gcloud/reference/app/deploy"}),"gcloud app deploy \xa0|\xa0 Cloud SDK \xa0|\xa0 Google Cloud"))))}k.isMDXComponent=!0;var h=function(e){var t=e.meta;return(0,r.jsx)(i.i,{meta:t,children:(0,r.jsx)(k,{})})};h.getInitialProps=(0,l.Z)(o().mark((function e(){var t,a;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n(405),a=t.entries,e.abrupt("return",{meta:a["blog/2019/01/deploy-app-engine-from-circleci"]});case 2:case"end":return e.stop()}}),e)})));var g=h},2006:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2019/01/deploy-app-engine-from-circleci",function(){return n(9461)}])}},function(e){e.O(0,[885,663,774,888,179],(function(){return t=2006,e(e.s=t);var t}));var t=e.O();_N_E=t}]);