(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[633],{9743:function(e,a,n){"use strict";n.r(a),n.d(a,{default:function(){return b}});var t=n(809),s=n.n(t),r=n(5311),o=n(5893),c=(n(7294),n(7871)),p=n(6265),l=n(8347),m=n(3905);function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function u(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){(0,p.Z)(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}var k={};function N(e){var a=e.components,n=(0,l.Z)(e,["components"]);return(0,m.kt)("wrapper",u(u(u({},k),n),{},{components:a,mdxType:"MDXLayout"}),(0,m.kt)("p",null,"Sometimes, especially in production environment, resources such as databases are only accessable from a k8s cluster for security purposes and cannot be accessed directly from your local machine. In this case, if you want to access the resource from your local machine, you need to create a tunnel service in the cluster."),(0,m.kt)("p",null,"Suppose the resource's ",(0,m.kt)("inlineCode",{parentName:"p"},"PORT")," is accessible as ",(0,m.kt)("inlineCode",{parentName:"p"},"ENDPOINT")," from the cluster, you can create a such tunnel service named ",(0,m.kt)("inlineCode",{parentName:"p"},"SERVICE_NAME")," by this command:"),(0,m.kt)("pre",u({},{className:"language-bash"}),(0,m.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"kubectl run ",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${SERVICE_NAME}")," --generator",(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),"run-pod/v1 --image",(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),"alpine/socat ",(0,m.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"\\"),"\n  -it --tty --rm --expose",(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),"true --port",(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${PORT}")," ",(0,m.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"\\"),"\n  tcp-listen:",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${PORT}"),",fork,reuseaddr ",(0,m.kt)("span",u({parentName:"code"},{className:"token punctuation"}),"\\"),"\n  tcp-connect:",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${ENDPOINT}"),(0,m.kt)("span",u({parentName:"code"},{className:"token builtin class-name"}),":"),(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${PORT}"),"\n")),(0,m.kt)("p",null,"and then forward local port to the service (execute in another terminal):"),(0,m.kt)("pre",u({},{className:"language-bash"}),(0,m.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"kubectl port-forward service/",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${SERVICE_NAME}")," ",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${PORT}"),(0,m.kt)("span",u({parentName:"code"},{className:"token builtin class-name"}),":"),(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"${PORT}"),"\n")),(0,m.kt)("p",null,"Now you can access the resource by accessing the local ",(0,m.kt)("inlineCode",{parentName:"p"},"PORT"),"."),(0,m.kt)("h2",null,"Scenario: Amazon Aurora Behind Amazon EKS"),(0,m.kt)("p",null,"Let's consider a realistic scenario: you have a k8s cluster running on Amazon EKS and a MySQL instance ",(0,m.kt)("inlineCode",{parentName:"p"},"my-mysql")," running on Amazon Aurora. The database's security group rejects all requests except from the k8s cluster."),(0,m.kt)("p",null,"In this case the ",(0,m.kt)("inlineCode",{parentName:"p"},"PORT")," is ",(0,m.kt)("inlineCode",{parentName:"p"},"3306")," (MySQL's default port number), and you can obtain ",(0,m.kt)("inlineCode",{parentName:"p"},"ENDPOINT")," using aws-cli as follows:"),(0,m.kt)("pre",u({},{className:"language-bash"}),(0,m.kt)("code",u({parentName:"pre"},{className:"language-bash"}),(0,m.kt)("span",u({parentName:"code"},{className:"token assign-left variable"}),"PORT"),(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),(0,m.kt)("span",u({parentName:"code"},{className:"token number"}),"3306"),"\n\n",(0,m.kt)("span",u({parentName:"code"},{className:"token assign-left variable"}),"ENDPOINT"),(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),(0,m.kt)("span",u({parentName:"span"},{className:"token variable"}),"$("),"aws rds describe-db-clusters ",(0,m.kt)("span",u({parentName:"span"},{className:"token punctuation"}),"\\"),"\n  --db-cluster-identifier",(0,m.kt)("span",u({parentName:"span"},{className:"token operator"}),"="),"my-mysql ",(0,m.kt)("span",u({parentName:"span"},{className:"token punctuation"}),"\\"),"\n  --query",(0,m.kt)("span",u({parentName:"span"},{className:"token operator"}),"="),(0,m.kt)("span",u({parentName:"span"},{className:"token string"}),'"DBClusters[0].Endpoint"')," ",(0,m.kt)("span",u({parentName:"span"},{className:"token punctuation"}),"\\"),"\n  --output",(0,m.kt)("span",u({parentName:"span"},{className:"token operator"}),"="),"text",(0,m.kt)("span",u({parentName:"span"},{className:"token variable"}),")")),"\n\n",(0,m.kt)("span",u({parentName:"code"},{className:"token assign-left variable"}),"SERVICE_NAME"),(0,m.kt)("span",u({parentName:"code"},{className:"token operator"}),"="),"mysql-tunnel\n")),(0,m.kt)("p",null,"When you create a tunnel service and start port-forwarding as described above, you can open a MySQL console to the Amazon Aurora by this command:"),(0,m.kt)("pre",u({},{className:"language-bash"}),(0,m.kt)("code",u({parentName:"pre"},{className:"language-bash"}),"mysql -h ",(0,m.kt)("span",u({parentName:"code"},{className:"token number"}),"127.0"),".0.1 -u ",(0,m.kt)("span",u({parentName:"code"},{className:"token variable"}),"$MYSQL_USER")," -p\n")))}N.isMDXComponent=!0;var d=function(e){var a=e.meta;return(0,o.jsx)(c.i,{meta:a,children:(0,o.jsx)(N,{})})};d.getInitialProps=(0,r.Z)(s().mark((function e(){var a,t;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n(405),t=a.entries,e.abrupt("return",{meta:t["blog/2020/07/connect-to-a-resource-behind-a-k9s-cluster-from-local-machine"]});case 2:case"end":return e.stop()}}),e)})));var b=d},7858:function(e,a,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2020/07/connect-to-a-resource-behind-a-k9s-cluster-from-local-machine",function(){return n(9743)}])}},function(e){e.O(0,[885,663,774,888,179],(function(){return a=7858,e(e.s=a);var a}));var a=e.O();_N_E=a}]);